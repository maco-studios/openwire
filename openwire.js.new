var OpenWire=function(e){"use strict";const t="data-openwire",n={COMPONENT:`${t}-component`,ID:`${t}-id`,NAME:`${t}-name`,STATE:`${t}-state`,INITIAL_DATA:`${t}-initial-data`,INITIALIZED:`${t}-initialized`,CLICK:`${t}-click`,SUBMIT:`${t}-submit`,MODEL:`${t}-model`,MODEL_MODE:`${t}-model-mode`,BIND:`${t}-bind`,DRAG:`${t}-drag`,DRAG_PARAMS:`${t}-drag-params`,DROP:`${t}-drop`,DROP_PARAMS:`${t}-drop-params`,SORTABLE:`${t}-sortable`,SORTABLE_PARAMS:`${t}-sortable-params`,SORTABLE_ITEM:"data-sortable-item",SORTABLE_INDEX:"data-sortable-index",IGNORE:`${t}-ignore`,IGNORE_PLACEHOLDER:`${t}-ignore-placeholder`,PARAMS:`${t}-params`},i={COMPONENT:`[${n.COMPONENT}]`,CLICK:`[${n.CLICK}]`,SUBMIT:`[${n.SUBMIT}]`,MODEL:`[${n.MODEL}]`,BIND:`[${n.BIND}]`,DRAG:`[${n.DRAG}]`,DROP:`[${n.DROP}]`,SORTABLE:`[${n.SORTABLE}]`,SORTABLE_ITEM:`[${n.SORTABLE_ITEM}]`,IGNORE:`[${n.IGNORE}]`},r="/openwire/update/index",s=300;function a(e,t={}){try{return JSON.parse(e)}catch(n){return t}}function o(){let e=window.FORM_KEY||window.formKey||"";if(!e){const t=document.querySelector('input[name="form_key"]');t&&(e=t.value||"")}return e}function d(...e){console.log("[OpenWire]",...e)}function l(...e){console.error("[OpenWire Error]",...e)}async function c(e,t){try{const n=await fetch(e,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Request failed with status: ${n.status}`);return await n.json()}catch(n){throw l("API request failed:",n),n}}function u(e,t,r={}){const s=(new DOMParser).parseFromString(t,"text/html").body.firstChild;if(!s)return void l("Empty HTML response, cannot update DOM");const a=document.activeElement;let o="",d="";a&&"INPUT"===a.tagName&&e.contains(a)&&(o=a.value,d=a.getAttribute(n.MODEL)||"");const c=Array.from(e.querySelectorAll(i.IGNORE)),u=[];if(c.forEach((e,t)=>{const i=document.createElement("div");i.setAttribute(n.IGNORE_PLACEHOLDER,t),e.parentNode.replaceChild(i,e),u.push({idx:t,node:e})}),e.innerHTML=s.innerHTML,u.forEach(t=>{const i=e.querySelector(`[${n.IGNORE_PLACEHOLDER}="${t.idx}"]`);i&&i.parentNode.replaceChild(t.node,i)}),d){const t=e.querySelector(`[${n.MODEL}="${d}"]`);if(t&&"INPUT"===t.tagName){t.value=o,t.focus();const e=t.value.length;t.setSelectionRange(e,e)}}!function(e,t={}){e.querySelectorAll(i.BIND).forEach(e=>{const i=e.getAttribute(n.BIND);i&&void 0!==t[i]&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName?e.value=t[i]:e.textContent=t[i])})}(e,r)}function p(e,t){t?e.classList.add("openwire-loading"):e.classList.remove("openwire-loading")}function h(e,t){e&&Array.isArray(e)&&e.forEach(e=>{try{const n=g[e.type];n?n(e,t):function(...e){console.warn("[OpenWire]",...e)}("Unknown effect type:",e.type)}catch(n){l("Error processing effect",e,n)}})}const g={notify(e){e.data&&e.data.message&&d(e.data.message)},registered(e,t){if(e.data&&e.data.id)try{const n=e.data.id;t&&t.element&&(t.element.setAttribute("data-openwire-id",n),t.id=n,window.openwireInstances=window.openwireInstances||{},window.openwireInstances[n]=t)}catch(n){l("Failed to apply registered id",e,n)}},redirect(e){if(!e.data||!e.data.url)return;"_blank"===(e.data.target||"_self")?window.open(e.data.url,"_blank"):window.location.href=e.data.url}};function f(e,t){"function"==typeof t?(g[e]=t,d(`Registered custom effect handler for "${e}"`)):l("Effect handler must be a function")}function E(e,t,r){e.querySelectorAll(i.SORTABLE).forEach(e=>{const s=e.getAttribute(n.SORTABLE),o=a(e.getAttribute(n.SORTABLE_PARAMS)||"[]",[]);e.querySelectorAll(i.SORTABLE_ITEM).forEach((e,i)=>{e.draggable=!0,e.setAttribute(n.SORTABLE_INDEX,i),e.addEventListener("dragstart",n=>{e.classList.add("openwire-sorting"),n.dataTransfer.setData("text/plain",JSON.stringify({method:s,params:o,componentId:t,itemIndex:i,itemId:e.id||e.getAttribute("data-id")||"unknown"}))}),e.addEventListener("dragend",t=>{e.classList.remove("openwire-sorting")})}),e.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),e.addEventListener("drop",t=>{t.preventDefault();try{const n=JSON.parse(t.dataTransfer.getData("text/plain")),a=function(e,t){const n=Array.from(e.querySelectorAll(i.SORTABLE_ITEM)),r=t.clientY;for(let i=0;i<n.length;i++){const e=n[i].getBoundingClientRect();if(r<e.top+e.height/2)return i}return n.length}(e,t);if(null!==a&&a!==n.itemIndex){const e=o.slice();e.unshift({fromIndex:n.itemIndex,toIndex:a,itemId:n.itemId}),r(s,e)}}catch(n){l("Error handling sortable drop",n)}})})}function m(e,t,r){const{call:s,updateImmediate:o,updateDebounced:c}=r;!function(e,t){e.querySelectorAll(i.CLICK).forEach(e=>{const i=e.getAttribute(n.CLICK),r=a(e.getAttribute(n.PARAMS)||"[]",[]);e.addEventListener("click",e=>{e.preventDefault(),t(i,r)})})}(e,s),function(e,t,r){e.querySelectorAll(i.MODEL).forEach(e=>{const i=e.getAttribute(n.MODEL);"lazy"===(e.getAttribute(n.MODEL_MODE)||"default")?(e.addEventListener("change",e=>{t(i,e.target.value)}),e.addEventListener("blur",e=>{t(i,e.target.value)})):e.addEventListener("input",e=>{r(i,e.target.value)})})}(e,o,c),function(e,t){e.querySelectorAll(i.SUBMIT).forEach(e=>{e.addEventListener("submit",i=>{i.preventDefault();const r=e.getAttribute(n.SUBMIT),s=a(e.getAttribute(n.PARAMS)||"[]",[]),o=new FormData(e),d={};o.forEach((e,t)=>{d[t]=e}),s.unshift(d),t(r,s)})})}(e,s),function(e,t){e.querySelectorAll(i.DRAG).forEach(e=>{const i=e.getAttribute(n.DRAG),r=a(e.getAttribute(n.DRAG_PARAMS)||"[]",[]);d("Setting up drag handler for element:",e,"method:",i),e.addEventListener("dragstart",n=>{d("Drag start event triggered for:",e),e.classList.add("openwire-dragging"),n.dataTransfer.setData("text/plain",JSON.stringify({method:i,params:r,componentId:t,elementId:e.id||e.getAttribute("data-id")||"unknown"})),n.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",t=>{d("Drag end event triggered for:",e),e.classList.remove("openwire-dragging")})})}(e,t),function(e,t){e.querySelectorAll(i.DROP).forEach(e=>{const i=e.getAttribute(n.DROP),r=a(e.getAttribute(n.DROP_PARAMS)||"[]",[]);e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move",e.classList.add("openwire-drag-over")}),e.addEventListener("dragleave",t=>{e.classList.remove("openwire-drag-over")}),e.addEventListener("drop",n=>{n.preventDefault(),e.classList.remove("openwire-drag-over");try{const e=JSON.parse(n.dataTransfer.getData("text/plain")),s=r.slice();s.unshift(e),t(i,s)}catch(s){l("Error handling drop",s)}})})}(e,s),E(e,t,s)}class A{constructor(e){this.element=e,this.id=e.getAttribute(n.ID)||function(e="openwire"){return`${e}-${Date.now()}_${Math.floor(1e4*Math.random())}`}(),this.name=e.getAttribute(n.NAME);const t=e.getAttribute(n.INITIAL_DATA)||"{}";this.data=a(t,{}),this.pendingUpdates={},this.updateQueue=[],this.processingQueue=!1,this.debouncedUpdate=function(e,t){let n;return function(...i){const r=this;clearTimeout(n),n=setTimeout(()=>{e.apply(r,i)},t)}}((e,t)=>{this.updateProperty(e,t)},s),this.setupEventHandlers(),d("Component initialized:",this.id,this.name)}setupEventHandlers(){const e={call:this.callMethod.bind(this),updateImmediate:this.updateProperty.bind(this),updateDebounced:this.debouncedUpdate.bind(this)};m(this.element,this.id,e)}callMethod(e,t=[]){d(`Calling method: ${e}`,t),this.showLoading();const i={id:this.id,calls:[{method:e,params:t}],form_key:o()};this.element.hasAttribute(n.NAME)&&(i.server_class=this.element.getAttribute(n.NAME));const s=this.element.getAttribute(n.STATE);s&&(i.initial_state=a(s,{})),function(e,t){return c(e,t)}(r,i).then(e=>{this.processResponse(e)}).catch(t=>{throw l(`Error calling ${e}:`,t),t}).finally(()=>{this.hideLoading()})}updateProperty(e,t){d(`Updating property: ${e}`,t),this.pendingUpdates[e]=t,this.updateQueue.includes(e)||this.updateQueue.push(e),this.processingQueue||this.processUpdateQueue()}processUpdateQueue(){if(this.processingQueue=!0,0===this.updateQueue.length)return void(this.processingQueue=!1);const e=this.updateQueue.shift(),t=this.pendingUpdates[e];delete this.pendingUpdates[e];const i={};i[e]=t;const s={id:this.id,updates:i,form_key:o()};this.element.hasAttribute(n.NAME)&&(s.server_class=this.element.getAttribute(n.NAME));const d=this.element.getAttribute(n.STATE);d&&(s.initial_state=a(d,{})),function(e,t){return c(e,t)}(r,s).then(e=>{this.processResponse(e)}).catch(t=>{throw l(`Error updating ${e}:`,t),t}).finally(()=>{this.processUpdateQueue()})}processResponse(e){e&&"object"==typeof e?(e.data&&(this.data=e.data),e.html&&(u(this.element,e.html),this.setupEventHandlers()),e.effects&&Array.isArray(e.effects)&&h(e.effects,this)):l("Invalid response received:",e)}getData(){return this.data}refresh(){this.callMethod("$refresh")}showLoading(){p(this.element,!0)}hideLoading(){p(this.element,!1)}}const O=new Map;class L{constructor(e,t={}){this.name=e,this.options=t,this.initialized=!1,d(`Plugin ${e} created`)}init(e){if(!this.initialized)try{d(`Plugin ${this.name} initialized`),this.initialized=!0}catch(t){l(`Error initializing plugin ${this.name}:`,t)}}destroy(){if(this.initialized)try{d(`Plugin ${this.name} destroyed`),this.initialized=!1}catch(e){l(`Error destroying plugin ${this.name}:`,e)}}}function I(e){return e instanceof L?O.has(e.name)?(l(`Plugin ${e.name} is already registered`),!1):(O.set(e.name,e),d(`Plugin ${e.name} registered`),!0):(l("Invalid plugin:",e),!1)}function w(e){if(!O.has(e))return l(`Plugin ${e} is not registered`),!1;return O.get(e).destroy(),O.delete(e),d(`Plugin ${e} unregistered`),!0}const y=new class{constructor(){this.components=new Map,this.initialized=!1,this.init=this.init.bind(this),this.registerComponents=this.registerComponents.bind(this),this.registerEffectHandlers=this.registerEffectHandlers.bind(this),d("OpenWire created")}init(){var e;this.initialized?d("OpenWire already initialized"):(d("Initializing OpenWire"),this.registerEffectHandlers(),this.registerComponents(),this.setupMutationObserver(),e=this,O.forEach(t=>{t.init(e)}),this.initialized=!0,d("OpenWire initialization complete"))}registerComponents(){const e=document.querySelectorAll(i.COMPONENT);d(`Found ${e.length} OpenWire components`),e.forEach(e=>{this.registerComponent(e)})}registerComponent(e){try{const t=e.getAttribute(n.ID);if(t&&this.components.has(t))return d(`Component ${t} already registered`),this.components.get(t);const i=new A(e);return this.components.set(i.id,i),e.setAttribute(n.INITIALIZED,"true"),d(`Registered component: ${i.id}`),i}catch(t){return l("Error registering component:",t),null}}registerEffectHandlers(){f("redirect",e=>{e.url&&(d("Redirecting to:",e.url),window.location.href=e.url)}),f("alert",e=>{e.message&&alert(e.message)}),f("reload",()=>{window.location.reload()}),f("focus",e=>{if(e.selector){const t=document.querySelector(e.selector);t&&t.focus()}})}setupMutationObserver(){new MutationObserver(e=>{let t=!1;e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{if(1===e.nodeType&&(e.hasAttribute&&e.hasAttribute(n.COMPONENT)&&this.registerComponent(e),e.querySelectorAll)){e.querySelectorAll(i.COMPONENT).length>0&&(t=!0)}})}),t&&this.registerComponents()}).observe(document.body,{childList:!0,subtree:!0}),d("Mutation observer set up")}getComponent(e){return this.components.get(e)}getComponents(){return this.components}registerEffect(e,t){f(e,t)}};return document.addEventListener("DOMContentLoaded",()=>{y.init()}),window.OpenWire=y,window.OpenWirePlugin=L,window.registerOpenWirePlugin=I,window.unregisterOpenWirePlugin=w,console.log("OpenWire JS loaded"),e.ATTR=n,e.CLASS={LOADING:"openwire-loading",DRAGGING:"openwire-dragging",DRAG_OVER:"openwire-drag-over",SORTING:"openwire-sorting",DRAG_PLACEHOLDER:"openwire-drag-placeholder"},e.PREFIX=t,e.Plugin=L,e.SELECTOR=i,e.openwire=y,e.registerEffectHandler=f,e.registerPlugin=I,e.unregisterPlugin=w,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});
